# SpaceshipCoder Engine Design

## Overview

SpaceshipCoder is a real-time multiplayer spaceship simulation engine. Players connect via Socket.IO clients, authenticate with session tokens linked to entities, and execute operations (ops) on their entities. The engine processes ops in a rate-limited queue, updates entity states, and broadcasts changes.

## Architecture

- **Server-Side**: Node.js with Express, Socket.IO, Mongoose (MongoDB).
- **Client-Side**: Socket.IO clients send ops; API auto-generated from server functions.
- **Real-Time**: Event-driven with global event queue and observers.
- **Persistence**: Entities, users, sessions stored in MongoDB.

## Client-Side Architecture

- **Client Folder**: Auto-generated API for remote function calls.
- **client/client.js**: Socket.IO client that loads user scripts, connects with token, emits ops.
- **client/functions.js**: Wrappers for each server function (generated by `src/buildClientAPI.js`).
- **Usage**: `node client/client.js <script.js>` â€“ script imports functions, calls them (sends ops).

## Components

### Engine (`src/engine.js`)

- Manages global state: `entities`, `events`, `observers`.
- `pushOp(entityId, functionName, args)`: Queues ops per entity, rate-limited (max 20 ops, 1 per tick).
- Loads entities from DB on startup.
- Processes ops asynchronously, calling functions from `functions.js`.

### Functions (`src/functions.js`)

- Utility functions for entity operations: `randomBetween`, `propulsion`, `getPosition`, etc.
- `memory`: Proxy for state storage (size-limited, no functions).
- Exported functions are callable via ops.

### Server (`src/server.js`)

- Express app with Socket.IO.
- Auth: Sessions via tokens (expire 2h).
- Routes: `/login` (POST) creates session.
- Socket events: `'op'` (entityId, functionName, args) -> `engine.pushOp`.
- Starts engine on boot.

### Database (`src/database.js`)

- Models: `Entity` (name, classification, owner), `User`, `Session` (token, userId, entityId).
- Indexes: Unique entity per owner.
- `initDatabase()`: Connects to MongoDB.

### Build Client API (`src/buildClientAPI.js`)

- Generates `./client/functions.js` with wrappers for each exported function.
- Wrappers emit `'op'` messages to server.

## Data Flow

1. Client logs in via HTTP `/login` -> gets token.
2. Client connects Socket.IO with token -> auth middleware sets `socket.userId`, `socket.entityId`.
3. Client calls API functions -> emits `'op'` (entityId, func, args).
4. Server queues op in `engine.ops[entityId]`.
5. Engine processes queue, calls function, updates entity.
6. Events emitted, observers notified.

## Player API

- Client scripts import from `./client/functions.js`.
- Functions: Auto-generated wrappers for all `src/functions.js` exports (e.g., `getPosition`, `setForwardThrust`, `randomRange`, etc.).
- Example: `await setForwardThrust({id: 'ship-1'}, 0.5)` -> emits `'op'` to server.
- Scripts run via `client/client.js`, which executes a `step` function repeatedly.

## Events & Observables

- `events`: Global FIFO queue.
- `observers`: Map event keys to callbacks.
- Entities can observe events (e.g., `onEnginePulse`).

## Security

- Tokens required for Socket.IO auth.
- Ops rate-limited per entity.
- Memory proxy prevents function storage.

## Development

- Run server: `npm start`
- Seed DB: `node --input-type=module src/seed.js`
- Build client: `npm run build-client`
- Run client script: `TOKEN=abc123 node client/client.js ./myScript.js`
